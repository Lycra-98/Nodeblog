### node阶段博客项目的总结

这个项目更大程度体现了一个网站的基本开发,主要是服务器端和客户端之间的请求与响应，更大程度偏向于node开发就是服务器端的开发,而HTML页面只是起到了渲染数据库的数据模板作用,整个html页面中的脚本js代码更多的只是做一些验证表单,体验了一个网站的基本流程前端在页面中渲染后台的数据,后台把数据从数据库取出。让我稍微了解node开发基于服务器层面的一些知识,在频繁操作数据库的增删改查之中对我的逻辑有些提升。

同时在这次项目中比较充分的体现了模块化开发,各个js文件相互独立,需要的变量与函数进行导出供其他模板使用,主入口文件都是写的一些基本配置信息,例如为整个项目配置模板引擎以及静态资源,主路由路径，错误中间件等，而使用框架express进行网站开发确实更加高效，强大的中间件以及第三方依赖包更适合模块化开发使代码与文件夹结构看起来更加清晰与干净,比如说模块化路由,一般真实项目中路由会有很多,我们需要把主路由文件分开,然后分别建立二级路由,同时把路由的事件处理函数通过模块成员导出,供主路由使用。

这个项目比较频繁的操作数据库,对用户信息以及文章信息的增删改查,还有文章集合和用户集合的联合查询依赖关系,让前台模板的数据动态生成，更深层次的理解了post请求与get请求，通常一般表单数据如果不想让别人看见都使用post请求,如果要针对的利用一些特有属性做一些特定操作就比如说将id值(该值是唯一的)作为get请求参数,这样就能指定在数据库对某一个数据进行操作,还比如说有的页面模板是同一个比如这个项目中的用户修改页面和添加用户页面,我们要判断这两个请求的不同来渲染不同的数据到同一模块中，这里就使用id值作为判断条件

### 项目中遇到的一些问题

#### 登录功能

在做登录功能，我们会进行双重验证浏览器脚本js代码验证和node服务器端接受了数据之后的验证,主要是以防用户禁用了脚本js。再通过验证之后登陆成功之后我们要如何判断用户是否真的被服务器端所识别认识了,在登陆了之后做一些别的请求服务器端能让登录用户看到只有登陆之后才能看到的数据,而不是没有真正的将登录用户存入服务器端，因此我们借用基于express第三方包express-session将登录的用户存在session队中，响应给浏览器的时候将sessionid存入浏览器的cookie中，使浏览器和服务器在做完一次请求和响应后继续保持联系。同时我们将一些登陆用户信息存入session对象下方便做登录拦截判断,也需要存入locals中供所有模板使用该登陆用户的信息。

#### 新增用户功能

新增用户的时候我们依然选择了服务器端的验证注册的信息是否符合规则,使用了第三方模块joi来做一些对请求数据的验证和判断,通过服务器端验证后才能进行下一步，引用了bcrypt第三方模块对存入数据库的用户密码进行了加密,生成随机字符串对明文密码进行加密替换了加密密码之后存入数据库中,第二次修改的时候比对加密密码即可，使用了错误中间件来处理错误情况将对象转化为json格式字符串,然后错误处理中间件解析json格式字符串。

同时我们需要巧妙地将对象转化为get请求参数的形式,先转化为数组再转化为字符串，同时也需要将get请求参数截取出来转化成字符串相反操作即可。

```js
let result = JSON.parse(err);
    //let obj = {path: '/admin/user-edit', message: '密码比对失败,请输入正确密码才能修改信息', id: id};
    //用于拼接请求参数的数组
    let arr = [];
    //路径都是一样的,后面get请求参数不同,因此需要重新凭借path后面的请求参数
    for (let k in result) {
        if (k !== 'path') {
            arr.push(k + '=' + result[k]);
        }
    }
    // console.log(arr);拼接好数组为下面的,然后用join方法&分隔成字符串拼接到？问号后面即可
    //["message=密码比对失败,请输入正确密码才能修改信息","id=5e4f93fedab52110c0aa930c"]
    return res.redirect(`${result.path}?${arr.join('&')}`);
```

#### 删除用户功能

这里删除用户利用脚本js代码与node开发合作完成,脚本js利用事件触发将需要的数据传给表单隐藏域，我了解了表单隐藏域的功能主要用于传送数据而不被用户看到该表单控件。

#### 新增文章信息

表单如果涉及了文件上传，文件上传的数据是通过二进制的形式来进行数据传送的跟普通的数据不一样，我们使用formidable第三方模块来解析二进制表单数据，同时在脚本js中使用Filereder构造函数来读取文件实现预览效果，另外使用mongoose-sex-page第三方模块分页从数据库查询数据让我们对分页功能的设计更加简便化

```js
//1.创建解析表单实例化对象
    const form = new formidabal.IncomingForm();
    //2.配置文件上传的地址
    form.uploadDir = path.join(__dirname, '../', '../', 'public', 'uploads');
    //3.保存上传文件的后缀名
    form.keepExtensions = true;
    //4.解析表单
    form.parse(req, async (err, field, files) => {
        await Article.create({
            title: field.title,
            author: field.author,
            publishDate: field.publishDate,
            cover: files.cover.path.split('public')[1],
            content: field.content
        })
        //重定向回用户列表页面
        res.redirect('/admin/article');
    })
```

#### 文章评论功能

评论是属于具体的一篇文章同时一般需要登陆人的用户信息,所以在设计评论集合的规则时需要关联用户及文章集合，通过登陆成功后存在locals下的用户对象来判断用户是否登陆状态再决定评论框的显示和隐藏,所以在要退出用户的时候将locals下的该对象置空。利用唯一的文章id去查询属于这个文章的评论渲染到页面



### 学到的知识

1. 项目的开放环境和生产环境通过系统环境变量来判断,使用config第三方模块配置不同环境的配置信息，利于不同环境下代码的复用和维护
2. 服务器的session和浏览器的cookie
3. joi第三方模板验证数据
4. bcrypt第三方模板对密码进行加密
5. 表单隐藏域上传数据
6. 使用formidable第三方模板解析表单上传文件二进制数据，表单entype属性，脚本中Filereader构造函数读取数据
7. mongoose-sex-page第三方模板的分页查询数据库
8. mongodb数据库集合之间的关联查询,type值为id,ref为关联集合，poluplate(关联字段)联合查询
9. JQ中使用serializeArray()获取所有表单控制的值及name属性和value属性的值